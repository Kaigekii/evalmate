{% extends 'EvalMateApp/base_student_eval.html' %}
{% load static %}

{% block title %}{{ form.title }} - Evaluations{% endblock %}

{% block extra_css %}
<style>
    .eval-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-xl);
    }

    /* Hero Header */
    .eval-hero {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        color: var(--color-white);
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
    }

    .eval-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
    }

    .eval-hero__content {
        position: relative;
        z-index: 1;
    }

    /* Progress Steps */
    .progress-steps {
        display: flex;
        justify-content: center;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-sm);
        flex: 1;
        max-width: 200px;
    }

    .step__number {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--color-background);
        color: var(--color-text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        border: 3px solid var(--color-border);
        transition: all 0.3s ease;
    }

    .step--active .step__number {
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: var(--color-white);
        border-color: var(--color-primary);
        box-shadow: 0 4px 12px rgba(55, 53, 62, 0.3);
    }

    .step--completed .step__number {
        background: #10B981;
        color: var(--color-white);
        border-color: #10B981;
    }

    .step__label {
        font-weight: 600;
        color: var(--color-text-secondary);
        text-align: center;
    }

    .step--active .step__label,
    .step--completed .step__label {
        color: var(--color-primary);
    }

    /* Team Info Card */
    .team-info-card {
        background: var(--color-white);
        border-radius: var(--radius-xl);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
        margin-bottom: var(--spacing-xl);
    }

    .team-info-card__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--color-border);
    }

    .team-info-card__title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        font-family: 'Poppins', sans-serif;
    }

    .team-info-card__progress {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }

    /* Teammate Grid */
    .teammate-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
    }

    .teammate-card {
        background: var(--color-background);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        text-align: center;
        border: 2px solid var(--color-border);
        transition: all 0.3s ease;
        cursor: default;
    }

    .teammate-card--current {
        border-color: var(--color-primary);
        background: linear-gradient(135deg, rgba(55, 53, 62, 0.1), rgba(68, 68, 78, 0.05));
    }

    .teammate-card--pending {
        opacity: 0.6;
    }

    .teammate-card--completed {
        border-color: #10B981;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
    }

    .teammate-card__avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--color-accent), var(--color-accent-light));
        color: var(--color-white);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto var(--spacing-sm);
        font-size: 1.5rem;
        font-weight: 700;
        box-shadow: var(--shadow-md);
    }

    .teammate-card--completed .teammate-card__avatar {
        background: linear-gradient(135deg, #10B981, #059669);
    }

    .teammate-card__name {
        font-weight: 600;
        margin: 0 0 var(--spacing-xs) 0;
        color: var(--color-text);
    }

    .teammate-card__status {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-sm);
        display: inline-block;
    }

    .teammate-card__status--current {
        background: var(--color-primary);
        color: var(--color-white);
    }

    .teammate-card__status--pending {
        background: var(--color-border);
        color: var(--color-text-secondary);
    }

    .teammate-card__status--completed {
        background: #10B981;
        color: var(--color-white);
    }

    .teammate-card__edit-btn {
        margin-top: var(--spacing-sm);
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-family: 'Montserrat', sans-serif;
    }

    .teammate-card__edit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(113, 90, 90, 0.3);
    }

    .teammate-card--completed:hover {
        border-color: var(--color-accent);
        box-shadow: 0 4px 12px rgba(113, 90, 90, 0.15);
    }

    /* Evaluation Form */
    .eval-form-card {
        background: var(--color-white);
        border-radius: 16px;
        padding: 2.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }

    .eval-form-card__header {
        margin-bottom: 2rem;
    }

    .eval-form-card__title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--color-primary);
        margin: 0 0 0.5rem 0;
        font-family: 'Montserrat', sans-serif;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .eval-form-card__title::before {
        content: '';
        width: 4px;
        height: 32px;
        background: linear-gradient(180deg, var(--color-accent), #8b6f6f);
        border-radius: 2px;
    }

    .eval-form-card__title i {
        color: var(--color-accent);
        font-size: 1.5rem;
    }

    .eval-form-card__subtitle {
        color: #6b7280;
        margin: 0;
        font-size: 1rem;
        padding-left: 1.25rem;
    }

    /* Question Sections */
    .question-section {
        margin-bottom: 2.5rem;
    }

    .question-section__header {
        background: linear-gradient(135deg, #f9fafb, #f3f4f6);
        padding: 1.25rem 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--color-accent);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .question-section__title {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: var(--color-primary);
        font-family: 'Montserrat', sans-serif;
    }

    .question-section__description {
        margin: 0.5rem 0 0 0;
        color: #6b7280;
        font-size: 0.9375rem;
        line-height: 1.5;
    }

    /* Question Item */
    .question-item {
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
    }

    .question-item:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    .question-label {
        display: block;
        font-weight: 600;
        color: var(--color-primary);
        margin-bottom: 1rem;
        font-size: 1.0625rem;
        font-family: 'Montserrat', sans-serif;
        line-height: 1.5;
    }

    .question-label--required::after {
        content: ' *';
        color: #dc2626;
        font-weight: 700;
    }

    /* Rating Scale */
    .rating-scale {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .rating-option {
        position: relative;
        flex: 1;
        min-width: 90px;
    }

    .rating-option input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .rating-option label {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        width: 100%;
        background: #fafafa;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .rating-option input[type="radio"]:checked + label {
        background: linear-gradient(135deg, var(--color-accent), #8b6f6f);
        color: white;
        border-color: var(--color-accent);
        box-shadow: 0 4px 16px rgba(113, 90, 90, 0.4);
        transform: scale(1.05);
    }

    .rating-option label:hover {
        border-color: var(--color-accent);
        background: white;
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(113, 90, 90, 0.15);
    }

    .rating-number {
        font-size: 1.75rem;
        font-weight: 700;
        font-family: 'Montserrat', sans-serif;
    }

    .rating-label {
        font-size: 0.8125rem;
        text-align: center;
        font-weight: 600;
        font-family: 'Montserrat', sans-serif;
    }

    /* Text Response */
    .form-textarea {
        width: 100%;
        min-height: 140px;
        padding: 1rem 1.25rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        font-family: 'Montserrat', sans-serif;
        resize: vertical;
        transition: all 0.3s ease;
        background: #fafafa;
        line-height: 1.6;
    }

    .form-textarea:hover {
        border-color: #d1d5db;
        background: white;
    }

    .form-textarea:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 4px rgba(113, 90, 90, 0.1);
        background: white;
    }

    /* Multiple Choice */
    .multiple-choice, .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .choice-option, .checkbox-option {
        display: flex;
        align-items: center;
        padding: 1rem 1.25rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafafa;
    }

    .choice-option:hover, .checkbox-option:hover {
        border-color: var(--color-accent);
        background: white;
        box-shadow: 0 2px 8px rgba(113, 90, 90, 0.1);
    }

    .choice-option input[type="radio"],
    .checkbox-option input[type="checkbox"] {
        margin-right: 0.75rem;
        width: 22px;
        height: 22px;
        cursor: pointer;
        accent-color: var(--color-accent);
    }

    .choice-option label,
    .checkbox-option label {
        flex: 1;
        cursor: pointer;
        font-size: 1rem;
        font-family: 'Montserrat', sans-serif;
    }

    .choice-option input[type="radio"]:checked ~ label,
    .checkbox-option input[type="checkbox"]:checked ~ label {
        font-weight: 600;
        color: var(--color-accent);
    }

    .choice-option:has(input:checked),
    .checkbox-option:has(input:checked) {
        border-color: var(--color-accent);
        background: rgba(113, 90, 90, 0.05);
    }

    /* Slider */
    .slider-container {
        padding: 1rem 0;
    }

    .slider-labels {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        font-size: 0.9375rem;
        color: var(--color-primary);
        font-weight: 600;
        font-family: 'Montserrat', sans-serif;
    }

    .form-slider {
        width: 100%;
        height: 10px;
        border-radius: 8px;
        background: linear-gradient(to right, #c4a69e, #a08679, var(--color-accent), #8b6f6f, #5a4545);
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        cursor: pointer;
        position: relative;
    }

    .form-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: white;
        border: 4px solid var(--color-accent);
        cursor: pointer;
        box-shadow: 0 3px 12px rgba(113, 90, 90, 0.4);
        transition: all 0.3s ease;
    }

    .form-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 16px rgba(113, 90, 90, 0.5);
    }

    .form-slider::-moz-range-thumb {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: white;
        border: 4px solid var(--color-accent);
        cursor: pointer;
        box-shadow: 0 3px 12px rgba(113, 90, 90, 0.4);
        transition: all 0.3s ease;
    }

    .form-slider::-moz-range-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 16px rgba(113, 90, 90, 0.5);
    }

    .slider-value {
        display: block;
        text-align: center;
        margin-top: 0.75rem;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-accent);
        font-family: 'Montserrat', sans-serif;
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        margin-top: 2.5rem;
        padding-top: 2rem;
        border-top: 2px solid #f3f4f6;
        flex-wrap: wrap;
    }

    .btn-group {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 1rem 1.75rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        font-family: 'Montserrat', sans-serif;
        justify-content: center;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--color-accent), #5a4545);
        color: white;
        box-shadow: 0 4px 16px rgba(113, 90, 90, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(113, 90, 90, 0.4);
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: white;
        color: #6b7280;
        border: 2px solid #e5e7eb;
    }

    .btn-secondary:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: var(--color-primary);
    }

    .btn-back {
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        color: var(--color-primary);
        border: 2px solid #d1d5db;
    }

    .btn-back:hover {
        background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        transform: translateX(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    @keyframes float {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-20px);
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="eval-container">
        <!-- Hero Header -->
        <div class="eval-hero">
            <div class="eval-hero__content">
                <h1 class="eval-hero__title">{{ form.title }}</h1>
                <p class="eval-hero__subtitle">{{ form.description }}</p>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step step--completed">
                <div class="step__number">
                    <i class="fas fa-check"></i>
                </div>
                <div class="step__label">Team Setup</div>
            </div>
            <div class="step step--active">
                <div class="step__number">2</div>
                <div class="step__label">Evaluations</div>
            </div>
        </div>

        <!-- Team Info Card -->
        <div class="team-info-card">
            <div class="team-info-card__header">
                <h2 class="team-info-card__title">Team: {{ team_identifier }}</h2>
                <span class="team-info-card__progress">
                    {% if is_editing_existing %}
                        Editing: {{ current_teammate }} ({{ completed_count }} of {{ total_teammates }} completed)
                    {% else %}
                        Progress: {{ completed_count }} of {{ total_teammates }} completed
                    {% endif %}
                </span>
            </div>

            <div class="teammate-grid">
                {% for teammate in teammates %}
                <div class="teammate-card {% if teammate in completed_teammates %}teammate-card--completed{% elif forloop.counter0 == current_index %}teammate-card--current{% else %}teammate-card--pending{% endif %}" 
                     data-teammate-index="{{ forloop.counter0 }}"
                     {% if teammate in completed_teammates %}onclick="navigateToTeammate({{ forloop.counter0 }})" style="cursor: pointer;"{% endif %}>
                    <div class="teammate-card__avatar">
                        {% if teammate in completed_teammates %}
                            <i class="fas fa-check"></i>
                        {% else %}
                            {{ teammate.0 }}
                        {% endif %}
                    </div>
                    <h4 class="teammate-card__name">{{ teammate }}</h4>
                    <span class="teammate-card__status {% if teammate in completed_teammates %}teammate-card__status--completed{% elif forloop.counter0 == current_index %}teammate-card__status--current{% else %}teammate-card__status--pending{% endif %}">
                        {% if teammate in completed_teammates %}
                            Completed ✓
                        {% elif forloop.counter0 == current_index %}
                            Current
                        {% else %}
                            Pending
                        {% endif %}
                    </span>
                    {% if teammate in completed_teammates %}
                    <button type="button" class="teammate-card__edit-btn" onclick="event.stopPropagation(); navigateToTeammate({{ forloop.counter0 }})" title="Edit evaluation">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Evaluation Form -->
        <form method="POST" action="{% url 'student_eval_submit_evaluation' form.id %}" id="evaluationForm">
            {% csrf_token %}
            <input type="hidden" name="teammate_name" value="{{ current_teammate }}">
            <input type="hidden" name="teammate_index" value="{{ current_index }}">

            <div class="eval-form-card">
                <div class="eval-form-card__header">
                    <i class="fas fa-clipboard-list"></i>
                    <div>
                        <h3 class="eval-form-card__title">
                            {% if sections %}
                                {{ form.title }}
                            {% else %}
                                Evaluation Questions
                            {% endif %}
                        </h3>
                        <p class="eval-form-card__subtitle">
                            {% if is_editing_existing %}
                                <strong style="color: #2563eb;">✏️ Editing evaluation for: {{ current_teammate }}</strong>
                            {% else %}
                                Evaluating: <strong>{{ current_teammate }}</strong>
                            {% endif %}
                        </p>
                    </div>
                </div>

                {% if sections %}
                    {% for section in sections %}
                    <div class="question-section">
                        <div class="question-section__header">
                            <h4 class="question-section__title">{{ section.title }}</h4>
                            {% if section.description %}
                            <p class="question-section__description">{{ section.description }}</p>
                            {% endif %}
                        </div>

                        {% for question in section.questions %}
                        <div class="question-item">
                            <label class="question-label {% if question.required %}question-label--required{% endif %}">
                                {{ question.text }}
                            </label>

                            {% if question.type == 'rating' %}
                                <div class="rating-scale">
                                    {% for i in "12345" %}
                                    <div class="rating-option">
                                        <input 
                                            type="radio" 
                                            id="q{{ question.id }}_{{ i }}" 
                                            name="question_{{ question.id }}" 
                                            value="{{ i }}"
                                            {% if question.required %}required{% endif %}
                                        >
                                        <label for="q{{ question.id }}_{{ i }}">
                                            <span class="rating-number">{{ i }}</span>
                                            <span class="rating-label">
                                                {% if i == '1' %}Poor
                                                {% elif i == '2' %}Below Average
                                                {% elif i == '3' %}Average
                                                {% elif i == '4' %}Good
                                                {% elif i == '5' %}Excellent
                                                {% endif %}
                                            </span>
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% elif question.type == 'text' %}
                                <textarea 
                                    name="question_{{ question.id }}" 
                                    class="form-textarea"
                                    placeholder="Enter your response here..."
                                    {% if question.required %}required{% endif %}
                                ></textarea>
                            
                            {% elif question.type == 'multiple' %}
                                <div class="multiple-choice">
                                    {% for option in question.options.options %}
                                    <div class="choice-option">
                                        <input 
                                            type="radio" 
                                            id="q{{ question.id }}_opt{{ forloop.counter }}" 
                                            name="question_{{ question.id }}" 
                                            value="{{ option }}"
                                            {% if question.required %}required{% endif %}
                                        >
                                        <label for="q{{ question.id }}_opt{{ forloop.counter }}">{{ option }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            
                            {% elif question.type == 'checkbox' %}
                                <div class="checkbox-group">
                                    {% for option in question.options.options %}
                                    <div class="checkbox-option">
                                        <input 
                                            type="checkbox" 
                                            id="q{{ question.id }}_opt{{ forloop.counter }}" 
                                            name="question_{{ question.id }}" 
                                            value="{{ option }}"
                                        >
                                        <label for="q{{ question.id }}_opt{{ forloop.counter }}">{{ option }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            
                            {% elif question.type == 'slider' %}
                                <div class="slider-container">
                                    <div class="slider-labels">
                                        <span>{{ question.options.labels.0 }}</span>
                                        <span>{{ question.options.labels.1 }}</span>
                                    </div>
                                    <input 
                                        type="range" 
                                        name="question_{{ question.id }}" 
                                        min="{{ question.options.min }}" 
                                        max="{{ question.options.max }}" 
                                        step="{{ question.options.step }}"
                                        value="{{ question.options.min }}"
                                        class="form-slider"
                                        oninput="this.nextElementSibling.textContent = this.value"
                                    >
                                    <output class="slider-value">{{ question.options.min }}</output>
                                </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No evaluation questions have been configured for this form.</p>
                {% endif %}

                <!-- Actions -->
                <div class="form-actions">
                    <div class="btn-group">
                        <a href="{% url 'student_eval_team_setup' form.id %}?force_edit=1" class="btn btn-back" onclick="return confirm('Edit team setup? Your evaluation progress will be saved.');">
                            <i class="fas fa-edit"></i>
                            Edit Team Setup
                        </a>
                        
                        <button type="button" class="btn btn-secondary" id="saveDraftBtn" onclick="saveDraft()">
                            <i class="fas fa-save"></i>
                            Save Draft
                        </button>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        {% if completed_count >= total_teammates %}
                            Submit All Responses
                            <i class="fas fa-paper-plane"></i>
                        {% elif is_editing_existing %}
                            Save Changes & Continue
                            <i class="fas fa-check"></i>
                        {% else %}
                            Next Teammate
                            <i class="fas fa-arrow-right"></i>
                        {% endif %}
                    </button>
                </div>
                
                <div id="draftStatus" style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;"></div>
            </div>
        </form>
    </div>

    <script>
        // Debug: Log sections data
        console.log('Sections data:', {{ sections_json|safe }});
        console.log('Total teammates:', {{ total_teammates }});
        console.log('Current index:', {{ current_index }});
        
        // Form validation
        const evaluationForm = document.getElementById('evaluationForm');
        
        evaluationForm.addEventListener('submit', function(e) {
            const requiredFields = this.querySelectorAll('[required]');
            let allFilled = true;
            
            requiredFields.forEach(field => {
                if (field.type === 'radio') {
                    const radioGroup = this.querySelectorAll(`[name="${field.name}"]`);
                    const isChecked = Array.from(radioGroup).some(radio => radio.checked);
                    if (!isChecked) {
                        allFilled = false;
                    }
                } else if (!field.value.trim()) {
                    allFilled = false;
                }
            });
            
            if (!allFilled) {
                e.preventDefault();
                alert('Please answer all required questions before continuing.');
                return false;
            }
        });
        
        // ==================== Draft Functionality ====================
        
        const formId = {{ form.id }};
        const teamIdentifier = '{{ team_identifier }}';
        const currentTeammate = '{{ current_teammate }}';
        
        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Collect form data
        function collectFormData() {
            const formData = {};
            const form = document.getElementById('evaluationForm');
            const formElements = form.querySelectorAll('input, textarea, select');
            
            formElements.forEach(element => {
                if (element.name && element.name.startsWith('question_')) {
                    if (element.type === 'radio' || element.type === 'checkbox') {
                        if (element.checked) {
                            if (element.type === 'checkbox') {
                                if (!formData[element.name]) {
                                    formData[element.name] = [];
                                }
                                formData[element.name].push(element.value);
                            } else {
                                formData[element.name] = element.value;
                            }
                        }
                    } else {
                        formData[element.name] = element.value;
                    }
                }
            });
            
            return formData;
        }
        
        // Load draft data
        function loadFormData(draftData) {
            const form = document.getElementById('evaluationForm');
            
            Object.keys(draftData).forEach(fieldName => {
                const value = draftData[fieldName];
                const elements = form.querySelectorAll(`[name="${fieldName}"]`);
                
                elements.forEach(element => {
                    if (element.type === 'radio') {
                        if (element.value === value) {
                            element.checked = true;
                        }
                    } else if (element.type === 'checkbox') {
                        if (Array.isArray(value) && value.includes(element.value)) {
                            element.checked = true;
                        }
                    } else {
                        element.value = value;
                    }
                });
            });
        }
        
        // Save draft to server
        async function saveDraft() {
            const draftData = collectFormData();
            const statusEl = document.getElementById('draftStatus');
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            
            try {
                saveDraftBtn.disabled = true;
                statusEl.textContent = 'Saving draft...';
                statusEl.style.color = '#666';
                
                const response = await fetch('/api/student/draft/save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        form_id: formId,
                        draft_data: draftData,
                        team_identifier: teamIdentifier,
                        teammate_name: currentTeammate
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    statusEl.textContent = '✓ Draft saved successfully. Redirecting...';
                    statusEl.style.color = '#1E8449';
                    
                    // Mark as saved
                    window.draftSaved = true;
                    
                    // Redirect to student dashboard after 1 second
                    setTimeout(() => {
                        window.location.href = '/dashboard/student/#pending';
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to save draft');
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                statusEl.textContent = '✗ Failed to save draft';
                statusEl.style.color = '#dc3545';
            } finally {
                saveDraftBtn.disabled = false;
            }
        }
        
        // AUTO-SAVE REMOVED - Use manual "Save Draft" button only
        
        // Unsaved changes tracking removed - users can save manually with "Save Draft" button
        
        // Navigate to a specific teammate (for editing)
        function navigateToTeammate(index) {
            if (confirm('Switch to editing this teammate\'s evaluation?')) {
                window.location.href = `/forms/{{ form.id }}/eval/navigate/${index}/`;
            }
        }
        
        // Pre-fill form with saved answers if editing
        function prefillSavedAnswers() {
            const savedAnswers = {{ current_answers|safe|default:"{}" }};
            
            if (Object.keys(savedAnswers).length > 0) {
                console.log('Pre-filling form with saved answers:', savedAnswers);
                
                for (const [questionKey, answer] of Object.entries(savedAnswers)) {
                    const inputs = document.querySelectorAll(`[name="${questionKey}"]`);
                    
                    inputs.forEach(input => {
                        if (input.type === 'radio') {
                            if (input.value === answer) {
                                input.checked = true;
                            }
                        } else if (input.type === 'checkbox') {
                            // Handle comma-separated checkbox values
                            const answers = answer.split(', ');
                            if (answers.includes(input.value)) {
                                input.checked = true;
                            }
                        } else if (input.type === 'textarea' || input.tagName === 'TEXTAREA') {
                            input.value = answer;
                        } else {
                            input.value = answer;
                        }
                    });
                }
                
                // Show notification that we're editing
                const statusEl = document.getElementById('draftStatus');
                if (statusEl) {
                    statusEl.textContent = 'Editing saved evaluation for {{ current_teammate }}';
                    statusEl.style.color = '#2563eb';
                }
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            prefillSavedAnswers(); // Pre-fill saved evaluations
        });
    </script>
{% endblock %}
